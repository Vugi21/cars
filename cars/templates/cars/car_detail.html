{% extends 'cars/base.html' %}
{% load humanize %}
{% block content %}
<style>
  .car-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
  }
  
  .car-header h2 {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
  }
  
  .nav-tabs {
    border-bottom: 3px solid #e0e0e0;
    margin-bottom: 30px;
  }
  
  .nav-tabs .nav-link {
    color: #666;
    font-weight: 600;
    border: none;
    border-bottom: 3px solid transparent;
    padding: 12px 20px;
    transition: all 0.3s ease;
  }
  
  .nav-tabs .nav-link:hover {
    color: #667eea;
    border-bottom-color: #667eea;
  }
  
  .nav-tabs .nav-link.active {
    color: #667eea;
    background: transparent;
    border-bottom-color: #667eea;
  }
  
  .info-card {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 20px;
  }
  
  .info-item {
    display: flex;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #e0e0e0;
  }
  
  .info-item:last-child {
    border-bottom: none;
  }
  
  .info-label {
    font-weight: 600;
    color: #667eea;
    width: 120px;
    display: flex;
    align-items: center;
  }
  
  .info-value {
    color: #2c3e50;
    font-size: 1.05rem;
  }
  
  .sort-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 25px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
  }
  
  .sort-btn {
    padding: 8px 16px;
    border: 2px solid #ddd;
    border-radius: 8px;
    background: white;
    color: #666;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
  }
  
  .sort-btn:hover {
    border-color: #667eea;
    color: #667eea;
  }
  
  .sort-btn.active {
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    border-color: transparent;
    color: white;
  }
  
  .maintenance-card {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    border: none;
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s ease;
  }
  
  .maintenance-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  }
  
  .maintenance-card-body {
    background: white;
    padding: 20px;
  }
  
  .maintenance-date {
    font-size: 1rem;
    font-weight: 600;
    color: #667eea;
    display: flex;
    align-items: center;
    margin-bottom: 10px;
  }
  
  .maintenance-type {
    display: inline-block;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
  }
  
  .maintenance-notes {
    color: #666;
    margin: 15px 0;
    line-height: 1.6;
  }
  
  .maintenance-cost {
    color: #27ae60;
    font-size: 1.3rem;
    font-weight: 700;
    text-align: right;
  }
  
  .receipt-container {
    padding: 10px;
    background: #f0f4ff;
    border-radius: 8px;
    text-align: center;
  }
  
  .receipt-link {
    color: #667eea;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
  }
  
  .receipt-link:hover {
    color: #764ba2;
    text-decoration: underline;
    transform: scale(1.05);
  }
  
  .btn-add-record {
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 8px;
    padding: 12px 25px;
    color: white;
    font-weight: 600;
    transition: all 0.3s ease;
    margin-top: 20px;
  }
  
  .btn-add-record:hover {
    transform: scale(1.05);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
  }
  
  .empty-maintenance {
    text-align: center;
    padding: 40px;
    color: #999;
  }
  
  .empty-maintenance i {
    font-size: 3rem;
    color: #ddd;
    margin-bottom: 15px;
  }
  
  .modal-header {
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
  }
  
  .modal-header .btn-close {
    filter: brightness(0) invert(1);
  }
  
  .modal-body input,
  .modal-body select,
  .modal-body textarea {
    padding: 10px 12px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    width: 100%;
    transition: all 0.3s ease;
  }
  
  .modal-body input:focus,
  .modal-body select:focus,
  .modal-body textarea:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    outline: none;
  }
</style>

<div class="car-header">
  <h2>
    <i class="bi bi-car-front me-2"></i>{{ car.year }} {{ car.make }} {{ car.model }}
    {% if car.color %}<span style="font-size: 1.5rem;">({{ car.color }})</span>{% endif %}
  </h2>
</div>

<ul class="nav nav-tabs" id="detailTabs" role="tablist">
  <li class="nav-item">
    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#info">
      <i class="bi bi-info-circle me-2"></i>Car Info
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#history">
      <i class="bi bi-clock-history me-2"></i>Maintenance History
    </button>
  </li>
</ul>

<div class="tab-content">
  <!-- Info Tab -->
  <div class="tab-pane fade show active" id="info">
    <div class="info-card">
      <div class="info-item">
        <div class="info-label"><i class="bi bi-hash me-2"></i>VIN</div>
        <div class="info-value">{{ car.vin }}</div>
      </div>
      <div class="info-item">
        <div class="info-label"><i class="bi bi-calendar me-2"></i>Added On</div>
        <div class="info-value">{{ car.pk|date:"M d, Y" }}</div>
      </div>
    </div>
  </div>
  
  <!-- Maintenance Tab -->
  <div class="tab-pane fade" id="history">
    <div class="sort-buttons">
      <a href="?sort=-date#history" class="sort-btn {% if sort_by == '-date' %}active{% endif %}">
        <i class="bi bi-sort-down me-1"></i>Newest First
      </a>
      <a href="?sort=date#history" class="sort-btn {% if sort_by == 'date' %}active{% endif %}">
        <i class="bi bi-sort-up me-1"></i>Oldest First
      </a>
      <a href="?sort=-cost#history" class="sort-btn {% if sort_by == '-cost' %}active{% endif %}">
        <i class="bi bi-currency-dollar me-1"></i>Most Expensive
      </a>
      <a href="?sort=cost#history" class="sort-btn {% if sort_by == 'cost' %}active{% endif %}">
        <i class="bi bi-currency-dollar me-1"></i>Least Expensive
      </a>
    </div>
    
    <div class="row g-4">
      {% for m in maintenances %}
      <div class="col-md-6">
        <div class="maintenance-card">
          <div class="maintenance-card-body">
            <div class="maintenance-date">
              <i class="bi bi-calendar3 me-2"></i>{{ m.date|date:"M d, Y" }}
            </div>
            <div>
              <span class="maintenance-type">{{ m.service_type }}</span>
            </div>
            {% if m.mileage %}
              <p class="maintenance-notes" style="margin-bottom: 10px;">
                <i class="bi bi-speedometer2 me-1"></i><strong>Mileage:</strong> {{ m.mileage|intcomma }} miles
              </p>
            {% endif %}
            {% if m.notes %}
              <p class="maintenance-notes">{{ m.notes }}</p>
            {% endif %}
            {% if m.receipt %}
              <div class="receipt-container mt-3 mb-3">
                <a href="{{ m.receipt.url }}" target="_blank" class="receipt-link">
                  <i class="bi bi-file-earmark-image me-2"></i>View Receipt
                </a>
              </div>
            {% endif %}
            <div class="maintenance-cost">
              <i class="bi bi-currency-dollar"></i>{{ m.cost }}
            </div>
          </div>
        </div>
      </div>
      {% empty %}
        <div class="col-12">
          <div class="empty-maintenance">
            <i class="bi bi-calendar-x"></i>
            <h5>No Maintenance Records Yet</h5>
            <p>Start tracking your car's maintenance by adding your first record below.</p>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Add Maintenance Button -->
    <button class="btn btn-add-record" data-bs-toggle="modal" data-bs-target="#addMaintModal">
      <i class="bi bi-plus-circle me-2"></i>Add Maintenance Record
    </button>

    <!-- Modal -->
    <div class="modal fade" id="addMaintModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <form method="post">
            <div class="modal-header">
              <h5 class="modal-title">
                <i class="bi bi-tools me-2"></i>New Maintenance Record
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              {% csrf_token %}
              {{ form.as_p }}
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-add-record">
                <i class="bi bi-save me-1"></i>Save Record
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

<script>
  // Handle tab switching based on URL hash
  document.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash;
    if (hash === '#history') {
      const historyTab = document.querySelector('[data-bs-target="#history"]');
      if (historyTab) {
        const tab = new bootstrap.Tab(historyTab);
        tab.show();
      }
    }
    
    // Format mileage field with thousand separators
    const mileageField = document.querySelector('input[name="mileage"]');
    if (mileageField) {
      mileageField.addEventListener('input', function() {
        let value = this.value.replace(/,/g, '');
        if (value) {
          this.value = parseInt(value).toLocaleString('en-US');
        }
      });
      
      mileageField.addEventListener('blur', function() {
        let value = this.value.replace(/,/g, '');
        if (value) {
          this.value = parseInt(value).toLocaleString('en-US');
        }
      });
    }
  });
</script>
